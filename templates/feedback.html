{# Feedback component with collapsible sections #}
{% if question.feedback or question.suggestions %}
<div class="mt-4">
    {# Always Visible: Explanation - Separate Container #}
    {% if question.feedback and question.feedback.explanation %}
    <div class="p-4 bg-blue-50 border-l-4 border-blue-400">
        <h4 class="text-base font-semibold text-blue-800 mb-2">{{ t.explanation|upper }}</h4>
        <p class="text-base text-gray-800 leading-relaxed markdown-content">{{ question.feedback.explanation }}</p>
    </div>
    {% endif %}

    {# Dropdown Container: View Detailed Explanation & Learning Suggestions #}
    {% if question.feedback and (question.feedback.concept or question.feedback.key_points or (not question.correct|default(False) and question.feedback.hints)) or question.suggestions %}
    <div class="border border-gray-300 overflow-hidden {% if question.feedback and question.feedback.explanation %}mt-0{% endif %}">
        {# Collapsible 1: Core Concepts, Key Points & Hints #}
        {% if question.feedback and (question.feedback.concept or question.feedback.key_points or (not question.correct|default(False) and question.feedback.hints)) %}
        <div>
            <button onclick="toggleCollapsible(this)" 
                    class="w-full flex items-center justify-between p-4 bg-gray-100 hover:bg-gray-200 transition-colors text-left border-b border-gray-300">
                <span class="text-base font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    {{ t.view_detailed_explanation }}
                </span>
                <svg class="w-5 h-5 text-gray-600 transform transition-transform collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div class="collapsible-content hidden p-4 bg-white">
            {% if question.feedback.concept %}
            <div class="{% if question.feedback.key_points or (not question.correct|default(False) and question.feedback and question.feedback.hints) %}border-b border-gray-200 pb-4{% endif %}">
                <h4 class="text-base font-semibold text-gray-700 mb-2">{{ t.core_concept|upper }}</h4>
                <p class="text-base text-gray-800 markdown-content">{{ question.feedback.concept }}</p>
            </div>
            {% endif %}
            {% if question.feedback.key_points %}
            <div class="{% if question.feedback.concept %}pt-4{% endif %} {% if not question.correct|default(False) and question.feedback and question.feedback.hints %}border-b border-gray-200 pb-4{% endif %}">
                <h4 class="text-base font-semibold text-gray-700 mb-2">{{ t.key_points|upper }}</h4>
                <ol class="list-decimal list-inside space-y-1 text-base text-gray-800">
                    {% for point in question.feedback.key_points %}
                    <li class="markdown-content">{{ point }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}
            {# Hints (if wrong answer) - Inside View Explanations #}
            {% if not question.correct|default(False) and question.feedback and question.feedback.hints %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400">
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-amber-400 flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </div>
                        <div class="flex-1 mt-2">
                            <h4 class="text-base font-semibold text-yellow-800">{{ t.hints|upper }}</h4>
                            <ul class="list-disc list-inside space-y-1 text-base text-yellow-900 markdown-hints">
                                {% for hint in question.feedback.hints %}
                                <li class="markdown-content">{{ hint }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            </div>
        </div>
        {% endif %}

        {# Collapsible 2: Learning Suggestions #}
        {% if question.suggestions %}
        <div>
            <button onclick="toggleCollapsible(this)" 
                    class="w-full flex items-center justify-between p-4 bg-gray-100 hover:bg-gray-200 transition-colors text-left {% if question.feedback and (question.feedback.concept or question.feedback.key_points or (not question.correct|default(False) and question.feedback.hints)) %}border-t border-gray-300{% endif %}">
            <span class="text-base font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                {{ t.learning_suggestions }} ({{ question.suggestions|length }})
            </span>
            <svg class="w-5 h-5 text-gray-600 transform transition-transform collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        <div class="collapsible-content hidden p-4 bg-white">
            <div class="space-y-4">
                {% for suggestion in question.suggestions %}
                <div class="border-b border-gray-200 pb-4 last:border-b-0 last:pb-0">
                    <h4 class="text-base font-semibold text-gray-900 mb-2 markdown-content">{{ loop.index }}. {{ suggestion.title }}</h4>
                    {% if suggestion.explanation %}
                    <p class="text-base text-gray-700 mb-2 markdown-content">{{ suggestion.explanation }}</p>
                    {% endif %}
                    {% if suggestion.resources %}
                    <ul class="list-disc list-inside space-y-1 text-base text-gray-600">
                        {% for resource in suggestion.resources %}
                        <li>
                            {% set is_url = resource.startswith('http://') or resource.startswith('https://') or resource.startswith('www.') %}
                            {% if is_url %}
                                {% set url = resource if resource.startswith('http') else 'https://' + resource %}
                                {% set url_trimmed = url.rstrip('/') %}
                                {% set display_text = resource.rstrip('/') %}
                                <a href="{{ url_trimmed }}" target="_blank" rel="noopener noreferrer" 
                                   class="text-blue-600 hover:text-blue-800 underline">{{ display_text }}</a>
                            {% else %}
                                {{ resource }}
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function toggleCollapsible(button) {
    const content = button.nextElementSibling;
    const icon = button.querySelector('.collapsible-icon');
    const isHidden = content.classList.contains('hidden');
    
    if (isHidden) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-180');
        // Render markdown in visible content
        renderMarkdownInElement(content);
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-180');
    }
}

// Configure marked.js for flexible spacing
if (typeof marked !== 'undefined') {
    marked.setOptions({
        breaks: true,  // Treat single line breaks as <br>
        gfm: true,     // GitHub Flavored Markdown (more flexible)
        headerIds: false,
        mangle: false
    });
}

function renderMarkdownInElement(element) {
    if (typeof marked === 'undefined') return;
    
    const parseInline = (text) => {
        if (typeof marked.parseInline === 'function') return marked.parseInline(text);
        const parsed = marked.parse(text);
        const div = document.createElement('div');
        div.innerHTML = parsed;
        return div.textContent || parsed;
    };
    
    element.querySelectorAll('.markdown-content:not([data-rendered])').forEach(el => {
        const text = el.textContent;
        const isInline = ['LI', 'H4', 'SPAN', 'P'].includes(el.tagName);
        
        if (isInline) {
            el.innerHTML = parseInline(el.tagName === 'LI' ? text.replace(/^\d+\.\s*/, '') : text);
        } else {
            const parsed = marked.parse(text);
            if (parsed.match(/^<(p|div|ul|ol|li)/i)) {
                const div = document.createElement('div');
                div.innerHTML = parsed;
                el.innerHTML = div.textContent || parsed;
            } else {
                el.innerHTML = parsed;
            }
        }
        el.dataset.rendered = 'true';
    });
}

// Render markdown on page load for visible content
(function() {
    function initMarkdown() {
        if (typeof marked === 'undefined') {
            // Wait for marked.js to load
            setTimeout(initMarkdown, 100);
            return;
        }
        
        // Render markdown in initially visible feedback (explanation)
        const visibleExplanations = document.querySelectorAll('.bg-blue-50 .markdown-content');
        visibleExplanations.forEach(el => {
            if (el.textContent && !el.dataset.rendered) {
                const originalText = el.textContent;
                // Use block parsing for paragraphs
                el.innerHTML = marked.parse(originalText);
                el.dataset.rendered = 'true';
            }
        });
        
        // Render markdown in initially visible collapsible content
        document.querySelectorAll('.collapsible-content:not(.hidden)').forEach(renderMarkdownInElement);
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMarkdown);
    } else {
        initMarkdown();
    }
})();
</script>
{% endif %}

