<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/modal.js"></script>
    <style>
        body { font-family: 'Times New Roman', Times, serif; }
        .quiz-list::-webkit-scrollbar { width: 8px; }
        .quiz-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .quiz-list::-webkit-scrollbar-thumb { background: #888; }
    </style>
</head>
<body class="bg-white text-gray-800 max-w-full md:max-w-6xl mx-auto p-4 md:p-8">
    <div class="flex justify-between items-center border-b-2 border-gray-800 pb-2 mb-6">
        <h1 class="text-3xl text-gray-800">Quiz Platform</h1>
        <a href="https://github.com/alfaarizi/agentic-mcq-generator" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-gray-800 transition-colors" title="View on GitHub">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
        </a>
    </div>

    <div class="flex flex-col md:flex-row gap-6">
        <!-- Left: Scrollable Quiz List -->
        <div class="flex-1 md:flex md:flex-col md:max-h-[calc(100vh-200px)]">
            <div class="border border-gray-300 md:flex md:flex-col md:min-h-[calc(100vh-200px)]">
                <div class="px-3 py-2 border-b border-gray-300 bg-gray-50">
                    <h2 class="text-base font-medium text-gray-800">Quizzes</h2>
                </div>
                <div class="flex-1 overflow-y-auto md:pr-1 md:pl-2 quiz-list p-4 bg-gray-100 {% if not quizzes %}flex items-center justify-center{% endif %}">
            {% if quizzes %}
            {% for quiz in quizzes %}
                    <div class="border border-gray-300 bg-white p-5 mb-4 mx-2 group relative" data-slug="{{ quiz.slug }}">
                <button onclick="copyQuizLink(event, '{{ quiz.slug }}')" class="absolute left-2 top-7 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-gray-600 transition-all" title="Copy link">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                    </svg>
                </button>
                <div class="px-3">
                    <div class="flex justify-between items-baseline mb-2">
                        <div>
                            <h3 class="text-2xl quiz-title">{{ quiz.topic }}</h3>
                        </div>
                            {% if quiz.time_limit > 0 %}
                        <span class="text-gray-600 text-2xl">
                            ⏱️ {{ (quiz.time_limit // 60) }}m
                        </span>
                        {% endif %}
                    </div>
                    <p class="text-gray-600 text-base mb-4">
                        {{ quiz.questions }} question{% if quiz.questions != 1 %}s{% endif %}
                    </p>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="handleQuiz('{{ quiz.slug }}')" class="quiz-btn flex-1 bg-gray-800 hover:bg-gray-700 text-white py-2.5 px-4 text-base">
                        Start Quiz
                    </button>
                        <button onclick="generateMoreQuestions('{{ quiz.slug }}')" class="flex-1 sm:flex-initial sm:w-auto bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-3 text-sm flex items-center justify-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            <span>15</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
                    <p class="text-gray-600 text-base text-center">No quizzes available. Generate, upload a file, or create a quiz to get started.</p>
            {% endif %}
                </div>
            </div>
        </div>

        <!-- Separator for mobile -->
        <hr class="md:hidden border-gray-400">

        <!-- Right: Fixed Action Section with Tabs -->
        <div class="w-full md:w-96 md:flex-shrink-0 md:flex md:flex-col">
            <div class="border border-gray-300 md:flex md:flex-col md:min-h-[calc(100vh-200px)]">
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-300 bg-gray-50">
                    <button onclick="switchTab('generate')" id="tab-generate" class="flex-1 px-3 py-2 text-sm font-medium text-gray-800 bg-white border-b-2 border-gray-800 tab-button">
                        Generate
                    </button>
                    <button onclick="switchTab('create')" id="tab-create" class="flex-1 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 tab-button">
                        Create
                    </button>
                    <button onclick="switchTab('upload')" id="tab-upload" class="flex-1 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 tab-button">
                        Upload
                    </button>
                    <button onclick="switchTab('reset')" id="tab-reset" class="flex-1 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 tab-button">
                        Reset
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="p-4 flex-1 overflow-y-auto">
                    <!-- Generate Quiz Tab -->
                    <div id="content-generate" class="tab-content">
                        <h3 class="text-xl font-semibold mb-3">Generate Quiz</h3>
                        <form id="generateQuizForm" class="flex flex-col space-y-3">
                            <div>
                                <label for="topicInput" class="block text-base font-medium text-gray-700 mb-1">Topic Description</label>
                                <textarea 
                                    id="topicInput" 
                                    name="topic" 
                                    placeholder="Describe the topic...&#10;e.g., 'neural networks for CS students'" 
                                    required 
                                    class="w-full p-2 border border-gray-300 text-base resize-none focus:ring-2 focus:ring-gray-800 focus:border-gray-800" 
                                    style="height: 309px;"
                                    aria-label="Topic description for quiz generation"
                                ></textarea>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label for="complexitySelect" class="block text-sm font-medium text-gray-700 mb-1">Complexity</label>
                                    <select 
                                        id="complexitySelect" 
                                        name="complexity" 
                                        required
                                        class="w-full p-2 border border-gray-300 text-sm focus:ring-2 focus:ring-gray-800 focus:border-gray-800"
                                        aria-label="Question complexity level"
                                    >
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate" selected>Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                        <option value="expert">Expert</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="styleSelect" class="block text-sm font-medium text-gray-700 mb-1">Style</label>
                                    <select 
                                        id="styleSelect" 
                                        name="style" 
                                        required
                                        class="w-full p-2 border border-gray-300 text-sm focus:ring-2 focus:ring-gray-800 focus:border-gray-800"
                                        aria-label="Question presentation style"
                                    >
                                        <option value="academic" selected>Academic</option>
                                        <option value="conversational">Conversational</option>
                                        <option value="practical">Practical</option>
                                        <option value="concise">Concise</option>
                                    </select>
            </div>

                                <div>
                                    <label for="targetAudienceSelect" class="block text-sm font-medium text-gray-700 mb-1">Audience</label>
                                    <select 
                                        id="targetAudienceSelect" 
                                        name="target_audience" 
                                        required
                                        class="w-full p-2 border border-gray-300 text-sm focus:ring-2 focus:ring-gray-800 focus:border-gray-800"
                                        aria-label="Target audience level"
                                    >
                                        <option value="high_school">High School</option>
                                        <option value="undergraduate" selected>Undergraduate</option>
                                        <option value="graduate">Graduate</option>
                                        <option value="professional">Professional</option>
                                        <option value="general">General</option>
                                    </select>
                </div>
            </div>

                            <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-2.5 px-4 text-base transition-colors">Generate</button>
                        </form>
                    </div>

                    <!-- Upload Quiz Tab -->
                    <div id="content-upload" class="tab-content hidden">
                        <h3 class="text-xl font-semibold mb-4">Upload Quiz</h3>
                        <form action="{{ api_base_url }}/quizzes" method="post" enctype="multipart/form-data" class="space-y-3">
                            <input type="file" name="file" accept=".md" required class="w-full p-2 border border-gray-300 text-base">
                            <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-2.5 px-4 text-base">Upload</button>
                        </form>
                    </div>

                    <!-- Create Quiz Tab -->
                    <div id="content-create" class="tab-content hidden">
                        <h3 class="text-xl font-semibold mb-3">Create Quiz</h3>
                        <form id="createQuizForm" class="flex flex-col space-y-3">
                            <textarea 
                                id="quizContent" 
                                name="content" 
                                placeholder="Paste quiz content..&#10;&#10;e.g.,&#10;&lt;Math Basics&gt;&#10;What is 2 + 2?&#10;- 3&#10;&gt; 4&#10;&lt;/Math Basics&gt;&#10;&#10;For timed quiz:&#10;&lt;Math Basics:5&gt;&#10;What is 2 + 2?&#10;- 3&#10;&gt; 4&#10;&lt;/Math Basics&gt;" 
                                required 
                                class="w-full p-2 border border-gray-300 text-base resize-none" 
                                style="height: 415px;"
                            ></textarea>
                            <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-2.5 px-4 text-base">Create</button>
                        </form>
                    </div>

                    <!-- Reset Quizzes Tab -->
                    <div id="content-reset" class="tab-content hidden">
                        <h3 class="text-xl font-semibold mb-3">Reset Quizzes</h3>
                        <p class="text-gray-600 text-base mb-4">This action permanently deletes all quizzes. This cannot be undone.</p>
                        <button onclick="resetQuizzes()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 text-base">Reset All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
            <p id="loadingText" class="text-white mt-5">Processing...</p>
        </div>
    </div>

    {% include 'modal.html' %}

    <script>
        const API = '{{ api_base_url }}';
        
        // Loader functions
        function showLoader(text) {
            const loader = document.getElementById('loading');
            const loaderText = document.getElementById('loadingText');
            loaderText.textContent = text;
            loader.classList.replace('hidden', 'flex');
        }
        
        function hideLoader() {
            document.getElementById('loading').classList.replace('flex', 'hidden');
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-white', 'border-b-2', 'border-gray-800', 'text-gray-800');
                button.classList.add('text-gray-600');
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active state to selected tab
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('bg-white', 'border-b-2', 'border-gray-800', 'text-gray-800');
            activeTab.classList.remove('text-gray-600');

            // Persist active tab selection
            try {
                localStorage.setItem('quizzes_active_tab', tabName);
            } catch (e) {
                console.warn('Could not persist active tab:', e);
            }
        }

        async function copyQuizLink(e, slug) {
            e.stopPropagation();
            const url = `${window.location.origin}${API}/quizzes/${slug}`;
            const btn = e.currentTarget;
            const svg = btn.querySelector('svg');
            
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(url);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = url;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                
                btn.style.opacity = '1';
                svg.classList.add('text-green-600');
                svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />';
                setTimeout(() => {
                    btn.style.opacity = '';
                    svg.classList.remove('text-green-600');
                    svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />';
                }, 1500);
            } catch (err) {
                console.error('Failed to copy:', err);
                await showModal('Copy Failed', 'Failed to copy link. Please copy manually: ' + url);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Restore last active tab, default to 'generate'
            try {
                const activeTab = localStorage.getItem('quizzes_active_tab') || 'generate';
                const hasActiveTab = document.getElementById(`tab-${activeTab}`) && document.getElementById(`content-${activeTab}`);
                switchTab(hasActiveTab ? activeTab : 'generate');
            } catch (e) {
                switchTab('generate');
            }

            document.querySelectorAll('[data-slug]').forEach(el => {
                const slug = el.dataset.slug;
                const sessionId = localStorage.getItem('quiz_' + slug);
                const isCompleted = localStorage.getItem('quiz_' + slug + '_completed') === 'true';
                const score = localStorage.getItem('quiz_' + slug + '_score');
                const btn = el.querySelector('.quiz-btn');
                const title = el.querySelector('.quiz-title');
                
                title.className += ' text-blue-700 cursor-pointer';
                title.onclick = () => {
                    const url = isCompleted 
                        ? `${API}/quizzes/${slug}?session_id=${sessionId}`
                        : `${API}/quizzes/${slug}`;
                    location.href = url;
                };
                
                const titleText = title.textContent;
                title.innerHTML = `<span class="hover:underline">${titleText}</span>`;
                
                if (isCompleted) {
                    btn.textContent = 'Retake Quiz';
                    btn.className = btn.className.replace('bg-gray-800 hover:bg-gray-700', 'bg-blue-600 hover:bg-blue-700');
                    if (score) {
                        const scoreSpan = document.createElement('span');
                        scoreSpan.className = 'text-blue-600 text-2xl ml-2';
                        scoreSpan.textContent = `(${score})`;
                        title.appendChild(scoreSpan);
                    }
                }
            });
        });
        
        async function handleQuiz(slug) {
            const isCompleted = localStorage.getItem('quiz_' + slug + '_completed') === 'true';

            if (isCompleted) {
                const confirmed = await showModal(
                    'Retake Quiz',
                    'You have already taken this quiz. Start a new attempt?',
                    async () => {
                        await startQuizSession(slug);
                    }
                );
            } else {
                await startQuizSession(slug);
            }
        }

        async function startQuizSession(slug) {
            try {
                const res = await fetch(`${API}/quizzes/${slug}/sessions`, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json' }
                });

                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('quiz_' + slug, data.session_id);
                    localStorage.removeItem('quiz_' + slug + '_completed');
                    localStorage.removeItem('quiz_' + slug + '_score');
                    location.href = `${API}/quizzes/${slug}?session_id=${data.session_id}`;
                } else {
                    await showModal('Start Failed', 'Failed to start quiz. Please try again.');
                }
            } catch (e) {
                console.error(e);
                await showModal('Start Failed', 'Failed to start quiz. Please try again.');
            }
        }
        
        async function generateMoreQuestions(slug) {
            const confirmed = await showModal(
                'Generate More Questions',
                'This will add 15 new questions to this quiz. Continue?',
                async () => {
                    showLoader('Generating 15 new questions...');
                    try {
                        const res = await fetch(`${API}/quizzes/${slug}/generate`, {
                            method: 'POST',
                            headers: { 'Accept': 'application/json' }
                        });
                        
                        hideLoader();
                        
                        if (res.ok) {
                            const data = await res.json();
                            await showModal('Success', `Successfully generated ${data.new_count} questions! Total: ${data.total_questions}`);
                            location.reload();
                        } else {
                            const err = await res.json();
                            await showModal('Generation Failed', 'Failed to generate questions: ' + (err.detail || 'Unknown error'));
                        }
                    } catch (e) {
                        console.error(e);
                        hideLoader();
                        await showModal('Generation Failed', 'Failed to generate questions. Please try again.');
                    }
                }
            );
        }
        
        document.getElementById('generateQuizForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const topic = document.getElementById('topicInput').value.trim();
            const complexity = document.getElementById('complexitySelect').value;
            const style = document.getElementById('styleSelect').value;
            const targetAudience = document.getElementById('targetAudienceSelect').value;
            
            if (!topic) {
                await showModal('Validation Error', 'Please enter a topic description.');
                return;
            }
            
            try {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                
                // Show generating loader
                showLoader('Generating Quiz..');
                
                const res = await fetch(`${API}/quizzes/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        topic,
                        complexity,
                        style,
                        target_audience: targetAudience
                    })
                });
                
                hideLoader();
                submitBtn.disabled = false;
                
                if (res.ok) {
                    location.reload();
                } else {
                    const err = await res.json();
                    await showModal('Generation Failed', 'Failed to generate quiz: ' + (err.detail || 'Unknown error'));
                }
            } catch (e) {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                hideLoader();
                submitBtn.disabled = false;
                console.error(e);
                await showModal('Generation Failed', 'Failed to generate quiz. Please try again.');
            }
        });
        
        document.getElementById('createQuizForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('quizContent').value;
            
            try {
                const res = await fetch(`${API}/quizzes/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                if (res.ok) {
                    location.reload();
                } else {
                    const err = await res.json();
                    await showModal('Creation Failed', 'Failed to create quiz: ' + (err.detail || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                await showModal('Creation Failed', 'Failed to create quiz. Please try again.');
            }
        });
        
        async function resetQuizzes() {
            const confirmed = await showModal(
                'Reset All Quizzes',
                'Are you sure you want to delete all quizzes? This action cannot be undone.',
                async () => {
                    try {
                        const res = await fetch(`${API}/quizzes`, {
                            method: 'DELETE',
                            headers: { 'Accept': 'application/json' }
                        });

                        if (res.ok) {
                            localStorage.clear();
                            location.reload();
                        } else {
                            const err = await res.json();
                            await showModal('Reset Failed', 'Failed to reset quizzes: ' + (err.detail || 'Unknown error'));
                        }
                    } catch (e) {
                        console.error(e);
                        await showModal('Reset Failed', 'Failed to reset quizzes. Please try again.');
                    }
                }
            );
        }
    </script>
</body>
</html>
