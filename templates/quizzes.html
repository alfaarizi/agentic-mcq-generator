<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Times New Roman', Times, serif; }
    </style>
</head>
<body class="bg-white text-gray-800 max-w-3xl mx-auto p-8">
    <h1 class="text-3xl text-gray-800 border-b-2 border-gray-800 pb-2 mb-6">Quiz Platform</h1>

    {% if quizzes %}
    {% for quiz in quizzes %}
    <div class="border border-gray-300 p-5 mb-4" data-quiz-slug="{{ quiz.slug }}">
        <div class="flex justify-between items-baseline mb-2">
            <h3 class="text-xl quiz-title">{{ quiz.topic }}</h3>
            <span class="text-gray-600 text-sm">
                {% if quiz.time_limit > 0 %}
                    ‚è±Ô∏è {{ (quiz.time_limit // 60)|string.zfill(2) }}:{{ (quiz.time_limit % 60)|string.zfill(2) }}
                {% else %}
                    üìö No limit
                {% endif %}
            </span>
        </div>
        <p class="text-gray-600 mb-4">{{ quiz.questions }} questions</p>
        <button onclick="handleQuizAction('{{ quiz.slug }}')" class="quiz-button w-full bg-gray-800 hover:bg-gray-700 text-white py-2 px-4">
            Start Quiz
        </button>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-gray-600">No quizzes available. Upload a file below.</p>
    {% endif %}

    <hr class="my-8 border-gray-400">

    <h3 class="text-xl mb-4">Upload Quiz</h3>
    <form action="{{ api_base_url }}/quizzes" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".md" required class="w-full p-2 border border-gray-300 mb-3">
        <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-2 px-4">Upload</button>
    </form>

    <script>
        // Check which quizzes have been taken
        document.addEventListener('DOMContentLoaded', function() {
            const quizElements = document.querySelectorAll('[data-quiz-slug]');
            
            quizElements.forEach(function(element) {
                const slug = element.getAttribute('data-quiz-slug');
                const sessionId = localStorage.getItem('quiz_' + slug);
                const button = element.querySelector('.quiz-button');
                const title = element.querySelector('.quiz-title');
                
                if (sessionId) {
                    // Quiz has been taken - change button to "Retake Quiz"
                    button.textContent = 'Retake Quiz';
                    button.classList.remove('bg-gray-800', 'hover:bg-gray-700');
                    button.classList.add('bg-gray-600', 'hover:bg-gray-500');
                    
                    // Make title clickable to view results
                    title.classList.add('text-blue-700', 'hover:underline', 'cursor-pointer');
                    title.onclick = function() {
                        window.location.href = '{{ api_base_url }}/quizzes/' + slug + '?session_id=' + sessionId;
                    };
                }
            });
        });
        
        async function handleQuizAction(slug) {
            const sessionId = localStorage.getItem('quiz_' + slug);
            
            if (sessionId) {
                // Has existing session - ask if they want to retake
                if (confirm('You have already taken this quiz. Start a new attempt?')) {
                    // Clear old session and start new one
                    localStorage.removeItem('quiz_' + slug);
                    await startNewQuiz(slug);
                }
                // If cancel, do nothing (no redirect)
            } else {
                // No session - start new quiz
                await startNewQuiz(slug);
            }
        }
        
        async function startNewQuiz(slug) {
            try {
                const response = await fetch('{{ api_base_url }}/quizzes/' + slug + '/sessions', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Store session_id in localStorage
                    localStorage.setItem('quiz_' + slug, data.session_id);
                    // Redirect to quiz with session_id
                    window.location.href = '{{ api_base_url }}/quizzes/' + slug + '?session_id=' + data.session_id;
                } else {
                    alert('Failed to start quiz. Please try again.');
                }
            } catch (error) {
                console.error('Error starting quiz:', error);
                alert('Failed to start quiz. Please try again.');
            }
        }
    </script>
</body>
</html>
