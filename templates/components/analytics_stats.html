{% if plausible_domain %}
<div id="analytics-stats" class="mt-6 pt-4 border-t border-gray-200">
    <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-gray-600">
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Unique Visitors:</span>
            <span id="unique-visitors" class="font-medium text-gray-700 skeleton-text">---</span>
        </div>
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Page Views:</span>
            <span id="page-views" class="font-medium text-gray-700 skeleton-text">---</span>
        </div>
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Avg. Time on Site:</span>
            <span id="avg-time" class="font-medium text-gray-700 skeleton-text">--:--</span>
        </div>
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Returning Visitors:</span>
            <span id="return-rate" class="font-medium text-gray-700 skeleton-text">--.-%</span>
        </div>
    </div>
</div>

<style>
.skeleton-text {
    display: inline-block;
    background: #e5e7eb;
    border-radius: 2px;
    color: transparent;
    width: 5ch;
}

.skeleton-text.loaded {
    background: none;
    color: inherit;
    width: 5ch;
}
</style>

<script>
(async () => {
    if (!document.getElementById('analytics-stats')) return;
    
    // Cache configuration (TTL must match backend ANALYTICS_CACHE_TTL_SECONDS)
    const CACHE_KEY = 'analytics_stats';
    const CACHE_TTL = 180000; // 3 minutes (180 seconds)
    
    // Show error state (display '-' for all metrics)
    const showError = () => {
        document.querySelectorAll('.skeleton-text').forEach(el => {
            el.textContent = '-';
            el.classList.add('loaded');
        });
    };
    
    // Update UI with formatted analytics data
    const updateUI = (data) => {
        [
            ['unique-visitors', data.unique_visitors, (n) => n?.toLocaleString() ?? '-'],
            ['page-views', data.page_views, (n) => n?.toLocaleString() ?? '-'],
            ['avg-time', data.average_time, (t) => t ?? '0:00'],
            ['return-rate', data.return_visitor_rate, (n) => n != null ? `${n.toFixed(1)}%` : '-']
        ].forEach(([id, value, formatter]) => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = formatter(value);
                el.classList.add('loaded');
            }
        });
    };
    
    // Get cached data if still valid
    const getCached = () => {
        try {
            const analytics_cache = localStorage.getItem(CACHE_KEY);
            if (!analytics_cache) return null;
            const { data, timestamp } = JSON.parse(analytics_cache);
            return Date.now() - timestamp < CACHE_TTL ? data : null;
        } catch {
            return null;
        }
    };
    
    // Save data to cache
    const setCached = (data) => {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({ 
                data, 
                timestamp: Date.now() 
            }));
        } catch {}
    };
    
    // Main: Check cache first, then fetch if needed (stale-while-revalidate pattern)
    try {
        const analytics_cache = getCached();
        if (analytics_cache) {
            updateUI(analytics_cache);
            // Fetch fresh data in background to update cache
            fetch('{{ api_base_url }}/quizzes/analytics')
                .then(res => res.ok && res.json())
                .then(data => data && !data.error && setCached(data))
                .catch(() => {});
            return;
        }
        
        // No valid cache, fetch from API
        const res = await fetch('{{ api_base_url }}/quizzes/analytics');
        if (!res.ok || !res.headers.get('content-type')?.includes('application/json')) {
            showError();
            return;
        }
        
        const data = await res.json();
        if (data.error) {
            showError();
            return;
        }
        
        setCached(data);
        updateUI(data);
    } catch {
        showError();
    }
})();
</script>
{% endif %}
