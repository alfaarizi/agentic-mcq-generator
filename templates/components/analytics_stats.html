{% if plausible_domain %}
<div id="analytics-stats" class="mt-6 pt-4 border-t border-gray-200">
    <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-gray-600">
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Unique Visitors:</span>
            <span id="unique-visitors" class="font-medium text-gray-700 skeleton-text">---</span>
        </div>
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Page Views:</span>
            <span id="page-views" class="font-medium text-gray-700 skeleton-text">---</span>
        </div>
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Avg. Time on Site:</span>
            <span id="avg-time" class="font-medium text-gray-700 skeleton-text">--:--</span>
        </div>
        <div class="flex items-baseline gap-1.5 justify-center">
            <span class="text-gray-500">Returning Visitors:</span>
            <span id="return-rate" class="font-medium text-gray-700 skeleton-text">--.-%</span>
        </div>
    </div>
</div>

<style>
.skeleton-text {
    display: inline-block;
    background: #e5e7eb;
    border-radius: 2px;
    color: transparent;
    width: 5ch;
}

.skeleton-text.loaded {
    background: none;
    color: inherit;
    width: 5ch;
}
</style>

<script>
(async () => {
    if (!document.getElementById('analytics-stats')) return;
    
    const showError = () => {
        document.querySelectorAll('.skeleton-text').forEach(el => {
            el.textContent = '-';
            el.classList.add('loaded');
        });
    };
    
    try {
        const res = await fetch('{{ api_base_url }}/quizzes/analytics');
        if (!res.ok || !res.headers.get('content-type')?.includes('application/json')) {
            showError();
            return;
        }
        
        const data = await res.json();
        if (data.error) {
            showError();
            return;
        }
        
        const format = {
            number: (n) => n?.toLocaleString() ?? '-',
            percent: (n) => n != null ? `${n.toFixed(1)}%` : '-',
            time: (t) => t ?? '0:00'
        };
        
        const updates = [
            ['unique-visitors', data.unique_visitors, format.number],
            ['page-views', data.page_views, format.number],
            ['avg-time', data.average_time, format.time],
            ['return-rate', data.return_visitor_rate, format.percent]
        ];
        
        updates.forEach(([id, value, formatter]) => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = formatter(value);
                el.classList.add('loaded');
            }
        });
    } catch {
        showError();
    }
})();
</script>
{% endif %}
